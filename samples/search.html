<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="UTF-8">

    <title>OpenUi5 GoogleMaps Search</title>
    <style>
    #map1-map {
        margin: auto;
    }
    </style>
    <script id="sap-ui-bootstrap" type="text/javascript" src="../openui5/resources/sap-ui-core.js" data-sap-ui-theme="sap_bluecrystal" data-sap-ui-libs="sap.ui.layout, sap.ui.commons">
    </script>

    <script>
    //load googlemaps library
    sap.ui.getCore().loadLibrary("openui5.googlemaps", "../openui5/googlemaps/");

    var getLocationCallback = function(oPos) {
        oModel.setProperty('lat', oPos.lat, oContext);
        oModel.setProperty('lng', oPos.lng, oContext);
        oModel.setProperty('name', 'My Location', oContext);
    };

    var formatCenter = function(oV1, oV2) {
        return {
            lat: oV1,
            lng: oV2
        };
    };

    var onSuggest = function(oEvent) {
        var sValue = oEvent.getParameter("suggestValue");
        if (sValue.length > 3) {
            openui5.googlemaps.MapUtils.search({
                    'address': sValue
                },
                jQuery.proxy(searchResults, this))
        }
    };

    var onChange = function(oEvent) {
        if (oEvent) {
            var val = oEvent.getParameters('newValue').newValue;
            var oCtxt = oEvent.getSource().getBindingContext();
            this.locations.forEach(function(oLocation) {
                if (oLocation.value === val) {
                    oCtxt.getModel().setProperty('lat', oLocation.lat, oCtxt);
                    oCtxt.getModel().setProperty('lng', oLocation.lng, oCtxt);
                    oCtxt.getModel().setProperty('name', oLocation.value, oCtxt);
                }
            });
        }
    };

    var searchResults = function(results, status) {
        var that = this;
        this.destroyItems();
        this.locations = [];

        this.locations = jQuery.map(results, function(item) {
            var location = {};
            location.value = item.formatted_address;
            location.lat = item.geometry.location.lat();
            location.lng = item.geometry.location.lng();
            return location;
        });

        this.locations.forEach(function(item) {
            that.addItem(new sap.ui.core.ListItem({
                text: item.value,
            }));

        });
    };

    var places = [{
        name: "Bondi Beach",
        lat: -33.890542,
        lng: 151.274856,
    }];

    var oModel = new sap.ui.model.json.JSONModel();

    oModel.setData({
        places: places
    });

    sap.ui.getCore().setModel(oModel);

    var oContext = oModel.getContext('/places/0/');

    var oMarkers = new openui5.googlemaps.Marker({
        lat: '{lat}',
        lng: '{lng}',
        info: '{name}',
        icon: '{http://www.w3schools.com/googleapi/pinkball.png}',
        draggable: true
    });

    var oMap = new openui5.googlemaps.Map("map1", {
        center: {
            parts: ["lat", "lng"],
            formatter: formatCenter
        },
        zoom: 12,
        width: '600px',
        height: '400px',
        layoutData: new sap.ui.layout.GridData({
            span: "L8 M12 S12"
        }),
        markers: {
            path: "/places",
            template: oMarkers
        }
    });

  //get current location
   openui5.googlemaps.MapUtils.currentPosition(getLocationCallback);

    var oLayout1 = new sap.ui.layout.form.ResponsiveGridLayout();
    var oForm1 = new sap.ui.layout.form.Form({
        title: new sap.ui.core.Title({
            text: "Sample Map Search",
        }),
        layout: oLayout1,
        formContainers: [new sap.ui.layout.form.FormContainer({
            formElements: [


                new sap.ui.layout.form.FormElement({
                    label: new sap.ui.commons.Label({
                        text: "Query Address"
                    }),
                    fields: [new sap.ui.commons.AutoComplete({
                        change: onChange,
                        layoutData: new sap.ui.layout.GridData({
                            span: "L4 M6 S12"
                        }),
                        suggest: onSuggest
                    })]
                }),

                new sap.ui.layout.form.FormElement({
                    label: new sap.ui.commons.Label({
                        text: "Longitude / Latitude",
                    }),
                    fields: [new sap.ui.commons.TextField({
                            value: "{lat}",
                            layoutData: new sap.ui.layout.GridData({
                                span: "L2 M4 S8"
                            }),
                        }),
                        new sap.ui.commons.TextField({
                            value: "{lng}",
                            layoutData: new sap.ui.layout.GridData({
                                span: "L2 M4 S8"
                            }),
                        }),
                    ]
                }),
                new sap.ui.layout.form.FormElement({
                    fields: [oMap]
                }),
            ]
        }), ]
    });

    oForm1.placeAt('content');
    oForm1.setBindingContext(oContext);
    </script>

</head>

<body class="sapUiBody" role="application">
    <div id="content"></div>
</body>

</html>
